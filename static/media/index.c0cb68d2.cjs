"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var stream=require("stream"),util=require("util");function _interopDefaultLegacy(t){return t&&"object"===typeof t&&"default"in t?t:{default:t}}var stream__default=_interopDefaultLegacy(stream),util__default=_interopDefaultLegacy(util);const Transformer=function(t={},e){return this.options=t,void 0!==t.consume&&null!==t.consume||(this.options.consume=!1),this.options.objectMode=!0,void 0!==t.parallel&&null!==t.parallel||(this.options.parallel=100),void 0!==t.params&&null!==t.params||(t.params=null),this.handler=e,stream__default.default.Transform.call(this,this.options),this.state={running:0,started:0,finished:0},this};util__default.default.inherits(Transformer,stream__default.default.Transform),Transformer.prototype._transform=function(t,e,n){this.state.started++,this.state.running++,this.state.running<this.options.parallel&&(n(),n=null);try{let e=this.handler.length;if(null!==this.options.params&&e--,1===e)this.__done(null,[this.handler.call(this,t,this.options.params)],n);else{if(2!==e)throw Error("Invalid handler arguments");{const e=(t,...e)=>this.__done(t,e,n);this.handler.call(this,t,e,this.options.params)}}return!1}catch(r){this.__done(r)}},Transformer.prototype._flush=function(t){0===this.state.running?t():this._ending=function(){t()}},Transformer.prototype.__done=function(t,e,n){if(this.state.running--,t)return this.emit("error",t);this.state.finished++;for(let r of e)"number"===typeof r&&(r=`${r}`),void 0!==r&&null!==r&&""!==r&&this.push(r);n&&n(),this._ending&&0===this.state.running&&this._ending()};const transform=function(){let t,e,n,r={};for(let o=0;o<arguments.length;o++){const s=arguments[o];let i=typeof s;if(null===s?i="null":"object"===i&&Array.isArray(s)&&(i="array"),"array"===i)n=s;else if("object"===i)r={...s};else if("function"===i)e&&o===arguments.length-1?t=s:e=s;else if("null"!==i)throw new Error(`Invalid Arguments: got ${JSON.stringify(s)} at position ${o}`)}const s=new Transformer(r,e);let i=!1;if(n){const t=function(){for(const t of n){if(i)break;s.write(t)}s.end()};"function"===typeof setImmediate?setImmediate(t):setTimeout(t,0)}if(t||r.consume){const e=[];s.on("readable",(function(){let n;for(;null!==(n=s.read());)t&&e.push(n)})),s.on("error",(function(e){i=!0,t&&t(e)})),s.on("end",(function(){t&&!i&&t(null,e)}))}return s};exports.Transformer=Transformer,exports.transform=transform;